<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>My Profile | PIET Alumni Connect</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- CSS -->
  <link rel="stylesheet" href="/modern.css">
</head>

<body>

  <!-- NAVBAR -->
<header class="navbar">
  <div class="container nav-container">

    <!-- LEFT: LOGO + NAME -->
     <div class="hamburger" onclick="toggleMenu()">‚ò∞</div>
    <div class="nav-brand">
      <img src="alumni.png" alt="PIET Logo">
      <span>
        PIET Alumni Connect<br>
        <small>Alumni Society</small>
      </span>
    </div>

    <!-- CENTER: LINKS -->
    <div class="nav-links" id="navbarLinks">
      <a href="index.html">Home</a>
      <a href="alumni.html" data-role="student">Find Alumni</a>
      <a href="jobs.html" data-role="student,alumni">Jobs</a>
      <a href="groups.html" data-role="student,alumni">Groups</a>
      <a href="resources.html" data-role="student,alumni">Resources</a>
      <a href="messages.html" data-role="student,alumni">Messages</a>
    </div>

    <!-- RIGHT: USER PROFILE -->
    <div class="nav-user" id="navUser"></div>

  </div>
</header>


  <!-- MAIN -->
  <main class="container">

    <!-- HEADER -->
    <section class="card" style="margin-top:30px;">
      <h2>My Profile</h2>
      <p style="margin-top:6px; color:#6b7280;">
        View and update your personal and professional details.
      </p>
    </section>
    <div class="profile-photo-box">
  <img id="profilePhotoPreview" src="" alt="Profile Photo">
</div>

<h3 style="margin-top:20px;">Profile Photo</h3>
<input type="file" id="photoInput" accept="image/*">
<button id="uploadPhotoBtn">Replace Photo</button>
<button id="deletePhotoBtn">Delete Photo</button>


    <!-- PROFILE FORM -->
    <section class="card" style="margin-top:20px;">
      <form id="profileForm">

        <h3>Basic Information</h3>
        <input type="text" id="name" placeholder="Full Name" required>
        <input type="email" id="email" placeholder="Email" disabled>

        <h3 style="margin-top:20px;">Academic / Professional</h3>
        <input type="text" id="batch" placeholder="Batch (e.g. 2022)">
        <input type="text" id="domain" placeholder="Domain (e.g. Web, AI, Core CS)">
        <input type="text" id="company" placeholder="Company / College">
        <input type="text" id="location" placeholder="Location">

        <h3 style="margin-top:20px;">Social Links</h3>
        <input type="url" id="linkedin" placeholder="LinkedIn Profile URL">
        <input type="url" id="github" placeholder="GitHub Profile URL">

        <button type="submit" class="btn" style="margin-top:20px;">
          Save Changes
        </button>
        <button class="btn" onclick="requestUpgrade()">
  Request Alumni Role
</button>


      </form>
    </section>

  </main>

  <!-- FOOTER -->
  <footer>
    ¬© 2025 PIET Alumni Connect
  </footer>

  <!-- JS -->
  <script src="api.js"></script>
  <script src="protect.js"></script>
  <script src="roleNavbar.js"></script>
  <script src="logout.js"></script>
  <script src="navbarUser.js"></script>
  <script src="mobileNav.js"></script>

<script>
  const form = document.getElementById("profileForm");

  let authUser = null;

  // =========================
  // LOAD PROFILE
  // =========================
  async function loadProfile() {
    try {
      // 1Ô∏è‚É£ Get authenticated user from backend
      authUser = await apiCall("/api/auth/me");

      // 2Ô∏è‚É£ Get profile data
      const profile = await apiCall("/api/profile/me");

      // Basic user info
      document.getElementById("name").value = authUser?.name || "";
      document.getElementById("email").value = authUser?.email || "";

      // Profile fields
      document.getElementById("batch").value = profile.batch || "";
      document.getElementById("domain").value = profile.domain || "";
      document.getElementById("company").value = profile.company || "";
      document.getElementById("location").value = profile.location || "";
      document.getElementById("linkedin").value = profile.linkedin || "";
      document.getElementById("github").value = profile.github || "";

      // Profile photo preview
      const preview = document.getElementById("profilePhotoPreview");
      if (preview) {
        preview.src = authUser.photo
          ? API_BASE + authUser.photo
          : "https://ui-avatars.com/api/?name=" +
            encodeURIComponent(authUser.name || "User");
      }

    } catch (err) {
      console.error("LOAD PROFILE ERROR:", err);
      alert(err.message || "Failed to load profile");
    }
  }

  // =========================
  // UPDATE PROFILE
  // =========================
  form.addEventListener("submit", async (e) => {
    e.preventDefault();

    const data = {
      batch: document.getElementById("batch").value.trim(),
      domain: document.getElementById("domain").value.trim(),
      company: document.getElementById("company").value.trim(),
      location: document.getElementById("location").value.trim(),
      linkedin: document.getElementById("linkedin").value.trim(),
      github: document.getElementById("github").value.trim(),
    };

    try {
      await apiCall("/api/profile/me", "PUT", data);
      alert("Profile updated successfully!");
    } catch (err) {
      console.error("UPDATE PROFILE ERROR:", err);
      alert(err.message || "Failed to update profile");
    }
  });

  // =========================
  // UPLOAD PHOTO
  // =========================
  async function uploadPhoto() {
    const input = document.getElementById("photoInput");
    if (!input.files.length) {
      alert("Please select a photo");
      return;
    }

    const formData = new FormData();
    formData.append("photo", input.files[0]);

    try {
      const res = await fetch(`${API_BASE}/api/profile/upload-photo`, {
        method: "POST",
        credentials: "include", // üîê cookie auth
        body: formData,
      });

      const data = await res.json();
      if (!res.ok) throw new Error(data.message);

      alert("Photo uploaded successfully");
      location.reload();

    } catch (err) {
      console.error("UPLOAD ERROR:", err);
      alert(err.message || "Upload error");
    }
  }

  // =========================
  // DELETE PHOTO
  // =========================
  async function deletePhoto() {
    try {
      const res = await fetch(`${API_BASE}/api/profile/delete-photo`, {
        method: "DELETE",
        credentials: "include", // üîê cookie auth
      });

      const data = await res.json();
      if (!res.ok) throw new Error(data.message);

      alert("Photo deleted");
      location.reload();

    } catch (err) {
      console.error("DELETE PHOTO ERROR:", err);
      alert(err.message || "Delete error");
    }
  }

  // =========================
  // BUTTON HANDLERS
  // =========================
  const uploadBtn = document.getElementById("uploadPhotoBtn");
  if (uploadBtn) uploadBtn.addEventListener("click", uploadPhoto);

  const deleteBtn = document.getElementById("deletePhotoBtn");
  if (deleteBtn) deleteBtn.addEventListener("click", deletePhoto);

  // =========================
  // INIT
  // =========================
  loadProfile();
</script>
</body>
</html>
